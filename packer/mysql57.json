{
    "builders": [{
            "type": "amazon-ebs",
            "ami_name": "Percona Server for MySQL 5.7 [{{isotime \"2006-01-02 0304\"}}]",
            "instance_type": "t2.micro",
            "launch_block_device_mappings": [{
                    "delete_on_termination": true,
                    "device_name": "/dev/sda1",
                    "volume_size": 8,
                    "volume_type": "gp2"
                },
                {
                    "delete_on_termination": false,
                    "device_name": "/dev/sdb",
                    "volume_size": 50,
                    "volume_type": "gp2"
                }
            ],
            "region": "us-east-1",
            "security_group_id": "sg-4378343e",
            "source_ami": "ami-84b17092",
            "ssh_pty": "true",
            "ssh_username": "centos",
            "subnet_id": "subnet-4765a930"
        },
        {
            "type": "virtualbox-ovf",
            "vm_name": "Percona-Server-for-MySQL57-{{isotime \"2006-01-02-0304\"}}",
            "export_opts": [
                "--ovf10",
                "--manifest",
                "--vsys", "0",
                "--product", "Percona Server for MySQL 5.7",
                "--producturl", "https://www.percona.com/software/mysql-database/percona-server",
                "--vendor", "Percona",
                "--vendorurl", "https://www.percona.com",
                "--version", "{{isotime \"2006-01-02\"}}",
                "--description", "Percona Server for MySQL is a free, fully compatible, enhanced, open source drop-in replacement for MySQL that provides superior performance, scalability and instrumentation"
            ],
            "format": "ovf",
            "guest_additions_mode": "disable",
            "headless": true,
            "output_directory": "mysql57-virtualbox-ovf",
            "shutdown_command": "rm -rf ~/.ssh/authorized_keys; cat /dev/zero > zero.fill; sync; sleep 1; sync; rm -f zero.fill; sudo shutdown -P now",
            "source_path": ".cache/1708.01/box.ovf",
            "ssh_private_key_file": ".cache/id_rsa_vagrant",
            "ssh_pty": true,
            "ssh_username": "vagrant",
            "vboxmanage": [
                ["modifyvm", "{{.Name}}", "--memory", "1024"],
                ["modifyvm", "{{.Name}}", "--audio", "none"],
                ["modifyvm", "{{.Name}}", "--vrde", "off"],
                ["createhd", "--format", "VMDK", "--filename", "/tmp/{{.Name}}-disk2.vmdk", "--variant", "STREAM", "--size", "409600"],
                ["storagectl", "{{.Name}}", "--name", "SATA Controller", "--add", "sata", "--controller", "IntelAHCI"],
                ["storageattach", "{{.Name}}", "--storagectl", "SATA Controller", "--port", "1", "--type", "hdd", "--medium", "/tmp/{{.Name}}-disk2.vmdk"],
                ["modifyvm", "{{.Name}}", "--natpf1", "ssh,tcp,,22,,22"],
                ["modifyvm", "{{.Name}}", "--natpf1", "web,tcp,,80,,80"],
                ["modifyvm", "{{.Name}}", "--natpf1", "ssl,tcp,,443,,443"],
                ["modifyvm", "{{.Name}}", "--natpf1", "mysql,tcp,,3306,,3306"],
                ["modifyvm", "{{.Name}}", "--natpf1", "pmm0,tcp,,42000,,42000"],
                ["modifyvm", "{{.Name}}", "--natpf1", "pmm1,tcp,,42001,,42001"],
                ["modifyvm", "{{.Name}}", "--natpf1", "pmm2,tcp,,42002,,42002"],
                ["modifyvm", "{{.Name}}", "--natpf1", "pmm3,tcp,,42003,,42003"],
                ["modifyvm", "{{.Name}}", "--natpf1", "pmm4,tcp,,42004,,42004"],
                ["modifyvm", "{{.Name}}", "--natpf1", "pmm5,tcp,,42005,,42005"],
                ["modifyvm", "{{.Name}}", "--natpf1", "pmm6,tcp,,42006,,42006"],
                ["modifyvm", "{{.Name}}", "--natpf1", "pmm7,tcp,,42007,,42007"],
                ["modifyvm", "{{.Name}}", "--natpf1", "pmm8,tcp,,42008,,42008"],
                ["modifyvm", "{{.Name}}", "--natpf1", "pmm9,tcp,,42009,,42009"],
                ["modifyvm", "{{.Name}}", "--natpf1", "pmm10,tcp,,42010,,42010"]
            ]
        }
    ],
    "provisioners": [{
            "type": "shell",
            "inline": [
                "sudo yum -y install epel-release",
                "sudo yum -y install ansible bats"
            ]
        },
        {
            "type": "ansible-local",
            "playbook_file": "ansible/mysql57/main.yml",
            "extra_arguments": ["-v"],
            "role_paths": [
                "ansible/roles/cloud-node",
                "ansible/roles/mysql-init",
                "ansible/roles/nginx"
            ]
        },
        {
            "type": "file",
            "destination": "/tmp",
            "source": "test/integration/mysql57/bats"
        },
        {
            "type": "shell",
            "inline": [
                "sudo bats /tmp/bats/*.bats"
            ]
        }
    ],
    "post-processors": [
        [{
            "type": "shell-local",
            "only": ["virtualbox-ovf"],
            "inline_shebang": "/bin/bash",
            "inline": [
                "set -o errexit",
                "set -o xtrace",
                "pushd mysql57-virtualbox-ovf",
                "    NAME=$(ls *.ovf | sed -e 's/.ovf//')",
                "    sed -i'' -e 's/virtualbox-2.2/vmx-10/'        *.ovf",
                "    sed -i'' -e 's/ovf:id=\"80\"/ovf:id=\"102\"/' *.ovf",
                "    sed -i'' -e 's/>RedHat_64</>otherGuest</'     *.ovf",
                "    sha1sum *.ovf *.vmdk \\",
                "        | sed -E 's/^([^ ]+)  ([^ ]+)$/SHA1 (\\2)= \\1/' \\",
                "        > ${NAME}.mf",
                "    tar -cpf ${NAME}.ova *.ovf *.mf *-disk001.vmdk *-disk002.vmdk",
                "    rm -rf               *.ovf *.mf *-disk001.vmdk *-disk002.vmdk",
                "popd"
            ]
        }]
    ]
}
