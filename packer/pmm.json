{
    "builders": [
        {
            "type": "amazon-ebs",
            "ami_name": "PMM Server [{{isotime \"2006-01-02\"}}]",
            "instance_type": "t2.micro",
            "launch_block_device_mappings": [
                {
                    "delete_on_termination": true,
                    "device_name": "/dev/sda1",
                    "volume_size": 8,
                    "volume_type": "gp2"
                },
                {
                    "delete_on_termination": false,
                    "device_name": "/dev/sdb",
                    "iops": 5000,
                    "volume_size": 400,
                    "volume_type": "io1"
                }
            ],
            "region": "us-east-1",
            "security_group_id": "sg-4378343e",
            "source_ami": "ami-6d1c2007",
            "ssh_pty": "true",
            "ssh_username": "centos",
            "subnet_id": "subnet-4765a930"
        },
        {
            "type": "virtualbox-ovf",
            "vm_name": "PMM Server [{{isotime \"2006-01-02\"}}]",
            "export_opts": [
                "--manifest",
                "--vsys", "0",
                "--product", "Percona Monitoring and Management",
                "--producturl", "https://www.percona.com/software/database-tools/percona-monitoring-and-management",
                "--vendor", "Percona",
                "--vendorurl", "https://www.percona.com",
                "--version", "{{isotime \"2006-01-02\"}}",
                "--description", "Percona Monitoring and Management (PMM) is an open-source platform for managing and monitoring MySQL and MongoDB performance"
            ],
            "guest_additions_mode": "disable",
            "headless": true,
            "output_directory": "pmm-virtualbox-ovf",
            "shutdown_command": "rm -rf ~/.ssh/authorized_keys; cat /dev/zero > zero.fill; sync; sleep 1; sync; rm -f zero.fill; sudo shutdown -P now",
            "source_path": ".cache/CentOS-7-x86_64-Vagrant-1611_01.VirtualBox.ova",
            "ssh_private_key_file": ".cache/id_rsa_vagrant",
            "ssh_pty": true,
            "ssh_username": "vagrant",
            "vboxmanage": [
                [ "modifyvm", "{{.Name}}", "--memory", "1024" ],
                [ "createhd", "--format", "VMDK", "--filename", "/tmp/{{.Name}}-disk2.vmdk", "--variant", "STREAM", "--size", "409600" ],
                [ "storagectl", "{{.Name}}", "--name", "SATA Controller", "--add", "sata", "--controller", "IntelAHCI"],
                [ "storageattach", "{{.Name}}", "--storagectl", "SATA Controller", "--port", "1", "--type", "hdd", "--medium", "/tmp/{{.Name}}-disk2.vmdk" ]
            ]
        }
    ],
    "post-processors": [
        {
            "type": "shell-local",
            "inline": [
                "sed -i '' -e 's/[(].*.ovf[)]/(box.ovf)/' *-virtualbox-ovf/*.mf"
            ],
            "only": [
                "virtualbox-ovf"
            ]
        },
        {
            "type": "vagrant",
            "output": "PMM-Server-{{isotime \"2006-01-02\"}}.ova",
            "compression_level": "0",
            "only": [
                "virtualbox-ovf"
            ]
        },
        {
            "type": "shell-local",
            "inline": [
                "rm -rf pmm-virtualbox-ovf"
            ],
            "only": [
                "virtualbox-ovf"
            ]
        }
    ],
    "provisioners": [
        {
            "type": "shell",
            "inline": [
                "sudo yum -y install epel-release",
                "sudo yum -y install ansible bats"
            ]
        },
        {
            "type": "ansible-local",
            "playbook_file": "ansible/pmm/main.yml",
            "extra_arguments": [
                "-v"
            ],
            "role_paths": [
                "ansible/roles/cloud-node",
                "ansible/roles/mysql-init"
            ]
        },
        {
            "type": "ansible-local",
            "playbook_file": "ansible/related-to/ovf.yml",
            "only": [
                "virtualbox-ovf"
            ]
        },
        {
            "type": "ansible-local",
            "playbook_file": "ansible/related-to/pmm-ami.yml",
            "only": [
                "amazon-ebs"
            ]
        },
        {
            "type": "file",
            "destination": "/tmp",
            "source": "test/integration/pmm/bats"
        },
        {
            "type": "shell",
            "inline": [
                "sudo bats /tmp/bats/*.bats"
            ]
        }
    ]
}
